# =====================
# Docker Compose - TeamTo-Do (Producci√≥n con HTTPS)
# =====================
# Uso:
#   docker compose -f docker-compose.prod.yml up -d

services:
  # =====================
  # Base de Datos MySQL
  # =====================
  mysql:
    image: mysql:8.0
    container_name: teamtodo-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-teamtodo}
      MYSQL_USER: ${MYSQL_USER:-teamtodo}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - teamtodo-network

  # =====================
  # Backend NestJS
  # =====================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: teamtodo-backend
    restart: always
    environment:
      DATABASE_URL: mysql://${MYSQL_USER:-teamtodo}:${MYSQL_PASSWORD}@mysql:3306/${MYSQL_DATABASE:-teamtodo}
      FRONTEND_URL: https://${DOMAIN}
      FRONTEND_URLS: https://${DOMAIN},https://www.${DOMAIN}
      PORT: 3000
      NODE_ENV: production
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - teamtodo-network

  # =====================
  # Frontend React + Nginx
  # =====================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: /api
    container_name: teamtodo-frontend
    restart: always
    depends_on:
      - backend
    networks:
      - teamtodo-network

  # =====================
  # Nginx Reverse Proxy + SSL
  # =====================
  nginx-proxy:
    image: nginx:alpine
    container_name: teamtodo-nginx-proxy
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./certbot/conf:/etc/letsencrypt:ro
      - ./certbot/www:/var/www/certbot:ro
    depends_on:
      - frontend
      - backend
    networks:
      - teamtodo-network

  # =====================
  # Certbot para SSL
  # =====================
  certbot:
    image: certbot/certbot
    container_name: teamtodo-certbot
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    networks:
      - teamtodo-network

# =====================
# Volumes
# =====================
volumes:
  mysql_data:
    driver: local

# =====================
# Networks
# =====================
networks:
  teamtodo-network:
    driver: bridge
